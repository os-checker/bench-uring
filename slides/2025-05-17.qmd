---
title: "io-uring å¼‚æ­¥è¿è¡Œæ—¶åŸºå‡†æµ‹è¯•"
format: revealjs
editor: visual
---

```{r}
library(ggplot2)
library(dplyr)
# è‡ªåŠ¨åº”ç”¨ä¸­æ–‡å­—ä½“
showtext::showtext_auto()

# è®¾ç½®é»˜è®¤ä¸»é¢˜
font_ratio = 1
theme_set(
  theme_minimal() +
  theme(
    text = element_text(size = 16*font_ratio),  # è®¾ç½®å…¨å±€å­—ä½“å¤§å°ä¸º 16
    plot.title = element_text(size = 20*font_ratio, face = "bold"),
    axis.title = element_text(size = 16*font_ratio),
    axis.text = element_text(size = 14*font_ratio),
    legend.title = element_text(size = 16*font_ratio),
    legend.text = element_text(size = 14*font_ratio)
  )
)
```

```{r}
# Prepare
data <- read.csv("data.csv")
data$server_st <- data$server_st == "true"
data$client_st <- data$client_st == "true"
```

## Problem 1: async-uring åŸºå‡†æµ‹è¯•ä»£ç ä¸å®Œæ•´

r58Playz/async-uring#1ï¼š

[The bench.sh is incomplete on other runtimes](https://github.com/r58Playz/async-uring/issues/1)

## Problem 2: async-uring åœ¨ WSL ä¸Šç¼–è¯‘é”™è¯¯

``` bash
$ bash bench.sh echo 127.0.0.1:2345
    Finished `release` profile [optimized + debuginfo] target(s) in 0.23s
     Running `target/release/examples/echo '127.0.0.1:2345'`
Error: Io(Os { code: 22, kind: InvalidInput, message: "Invalid argument" })
```

é€šè¿‡è¿è¡Œ `uname -a` å‘½ä»¤ï¼Œæˆ‘å‘ç° Windows WSL2 çš„ ubuntu 24 çš„å†…æ ¸ç‰ˆæœ¬ä¸º 5.15ï¼Œä¸æ”¯æŒ 5.18 ä¹‹åçš„ [`setup_submit_all`](https://docs.rs/io-uring/0.7.6/io_uring/struct.Builder.html#method.setup_submit_all) è°ƒç”¨ã€‚

## Problem 3: async-uring åœ¨ WSL ä¸Šè¿è¡Œç¼“æ…¢

æ²¡æœ‰å¤ç°å®ƒçš„ README çš„åŸºå‡†æµ‹è¯•ç»“æœã€‚

## Problem 4ï¼štokio-uring å­˜åœ¨ bug

tokio-rs/tokio-uring#issue328ï¼š

[SIGABRT with "corrupted double-linked list" on multi-thread runtime](https://github.com/tokio-rs/tokio-uring/issues/328)

``` rust
Avg: 59384 (593841 / 10s) ğŸ‘ˆ all tasks finishes, but I got reports below
corrupted double-linked list
fish: Job 1, 'cargo run --example server_tokiâ€¦' terminated by signal SIGABRT (Abort)
```

## æœ¬å‘¨å·¥ä½œï¼šè‡ªå·±ç¼–å†™åŸºå‡†æµ‹è¯•ä»£ç 

``` bash
î—¾ bench-uring
ï‘¼ î—¾ examples
  â”‚ ó±˜— client_tokio_mt.rs
  â”‚ ó±˜— client_tokio_st.rs
  â”‚ ó±˜— server_monoio_mt.rs
  â”‚ ó±˜— server_monoio_st.rs
  â”‚ ó±˜— server_tokio_mt.rs
  â”‚ ó±˜— server_tokio_st.rs
  â”‚ ó±˜— server_tokio_uring_mt.rs
  â”” ó±˜— server_tokio_uring_st.rs
```

<https://github.com/os-checker/bench-uring>

------------------------------------------------------------------------

-   client: ä½¿ç”¨ tokio
    -   mt = 8 çº¿ç¨‹
    -   st = 1 çº¿ç¨‹
-   server
    -   monoio
    -   tokio_uring
    -   tokio
    -   å‰”é™¤ async-uring

æœåŠ¡ç«¯ä¹ŸåŒºåˆ†å¤šçº¿ç¨‹å’Œå•çº¿ç¨‹ã€‚

P.S. monoio å°šæœªç»‘å®šåˆ°å•æ ¸ã€‚

## Benchmarks

```{r p1, dev = "svg"}
filtered_data <- data %>%
  filter(socket_len == 100)

# å»é™¤ server åˆ—ä¸­çš„ "server_" å‰ç¼€
filtered_data$server <- sub("^server_", "", filtered_data$server)
filtered_data$client <- sub("^client_", "", filtered_data$client)
# ä¿®æ”¹æ ‡ç­¾æ ¼å¼
filtered_data$server <- sub("_st$", "\n(1 thread)", filtered_data$server)
filtered_data$server <- sub("_mt$", "\n(8 threads)", filtered_data$server)
filtered_data$client <- sub("_st$", " (1 thread)", filtered_data$client)
filtered_data$client <- sub("_mt$", " (8 threads)", filtered_data$client)

filtered_data <- filtered_data %>%
  group_by(server, client) %>%
  summarise(mbps = mean(mbps, na.rm = TRUE), .groups = 'drop')

# æŒ‰ mbps é™åºæ’åˆ—
filtered_data <- filtered_data %>%
  arrange(desc(mbps))

ggplot(filtered_data, aes(
  x = reorder(server, -mbps),
  y = mbps,
  fill = client
)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "MBps by Server with 100 sockets in a Client",
       x = "Server",
       y = "MBps",
       fill = "Client") +
  geom_text(
    aes(label = round(mbps, 0), color = client, fontface = "bold"),
    position = position_dodge(width = 0.9),
    vjust = -0.4,
    size = 2.8,
    show.legend = FALSE
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 0),
    # å¦‚æœæ ‡ç­¾è¿‡é•¿ï¼Œå¯ä»¥æ—‹è½¬æ ‡ç­¾
    legend.direction = "horizontal",
    legend.position = "inside",
    # å°†å›¾ä¾‹æ”¾å…¥ç»˜å›¾åŒº
    legend.position.inside = c(0.7, 0.88),
    legend.background = element_rect(fill = "white", color = NA),
  ) +
  scale_y_continuous(expand = c(0.08, 0))  # æ‰©å±• y è½´èŒƒå›´ï¼Œä¸ºæ ‡ç­¾æä¾›æ›´å¤šç©ºé—´
```

## Code LOC

```bash
bench-uring $ tokei
===============================================================================
 Language            Files        Lines         Code     Comments       Blanks
===============================================================================
 TOML                    1           25           18            3            4
-------------------------------------------------------------------------------
 Rust                   20          735          617           15          103
 |- Markdown             3           21            0           21            0
 (Total)                            756          617           36          103
===============================================================================
 Total                  21          760          635           18          107
===============================================================================
```

## Data

```{r}
data
```

